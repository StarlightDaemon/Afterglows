<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Stargate Dialing System Mark III - Rotary UI">
    <title>STARGATE DIALING SYSTEM v3.0</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div class="terminal" id="terminal">
        <!-- Header -->
        <header class="header">
            <span class="header-title">STARGATE DIALING SYSTEM</span>
            <div class="header-status">
                <span id="stateDisplay">IDLE</span>
                <div class="status-indicator" id="statusIndicator"></div>
            </div>
        </header>

        <!-- Gate Viewport (Left 60%) -->
        <main class="gate-viewport">
            <div class="stargate">
                <div class="outer-ring" id="outerRing">
                    <div class="chevron" data-num="1"></div>
                    <div class="chevron" data-num="2"></div>
                    <div class="chevron" data-num="3"></div>
                    <div class="chevron" data-num="4"></div>
                    <div class="chevron" data-num="5"></div>
                    <div class="chevron" data-num="6"></div>
                    <div class="chevron" data-num="7"></div>
                    <div class="chevron" data-num="8"></div>
                    <div class="chevron" data-num="9"></div>
                </div>
                <div class="inner-ring" id="innerRing"></div>
                <div class="symbol-track"></div>
                <div class="event-horizon" id="eventHorizon"></div>
            </div>
        </main>

        <!-- Control Panel (Right 40%) -->
        <aside class="control-panel">
            <!-- UTILITY AREA -->
            <section class="utility-area">
                <div class="section-header">UTILITY AREA</div>

                <!-- Mode Select -->
                <div class="mode-select" id="modeSegment" data-mode="7">
                    <div class="mode-title">MODE SELECT</div>
                    <div class="mode-arc">
                        <span class="mode-label" data-mode="8">8 [INTER]</span>
                        <span class="mode-label center active" data-mode="7">7 [INTRA]</span>
                        <span class="mode-label" data-mode="9">9 [DESTINY]</span>
                    </div>
                    <div class="rotary-container">
                        <svg class="rotary-knob" viewBox="0 0 100 100">
                            <defs>
                                <filter id="glow">
                                    <feGaussianBlur stdDeviation="2" result="blur" />
                                    <feMerge>
                                        <feMergeNode in="blur" />
                                        <feMergeNode in="SourceGraphic" />
                                    </feMerge>
                                </filter>
                            </defs>
                            <!-- Outer ring -->
                            <circle cx="50" cy="50" r="45" stroke="#00552a" stroke-width="2" fill="transparent" />

                            <!-- Rotor (Diagonal Bar) -->
                            <g class="knob-rotor">
                                <!-- The bar body -->
                                <rect x="35" y="10" width="30" height="80" rx="4" fill="#000" stroke="#00aa33"
                                    stroke-width="2" transform="rotate(45 50 50)" />
                                <!-- The indicator light on the bar -->
                                <rect x="42" y="15" width="16" height="8" rx="2" fill="#00ff41"
                                    transform="rotate(45 50 50)" filter="url(#glow)" />
                            </g>
                        </svg>
                    </div>
                </div>

                <!-- Address Buffer -->
                <div class="address-buffer">
                    <div class="buffer-title">ADDRESS BUFFER (9 SLOTS)</div>
                    <div class="slots-container" id="slotsContainer"></div>
                </div>

                <!-- Signal Strength -->
                <div class="signal-section">
                    <div class="signal-left">
                        <div class="signal-title">SIGNAL STRENGTH</div>
                        <div class="waveform-container">
                            <div class="waveform-line"></div>
                        </div>
                    </div>
                    <div class="signal-right">
                        <div class="bar-graph" id="barGraph"></div>
                        <div class="signal-stats">
                            <div>PEAK: <span class="value">98.4%</span></div>
                            <div>AVG: <span class="value">85.2%</span></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- INPUT AREA -->
            <section class="input-area">
                <div class="input-header">INPUT AREA</div>
                <div class="glyph-keyboard" id="glyphKeyboard"></div>

                <!-- Framed Engage Button -->
                <div class="engage-frame-container">
                    <div class="engage-corner top-left"></div>
                    <div class="engage-corner top-right"></div>
                    <div class="engage-corner bottom-left"></div>
                    <div class="engage-corner bottom-right"></div>
                    <button class="btn-engage" id="engageBtn" disabled>ENGAGE</button>
                </div>
            </section>
        </aside>
    </div>

    <!-- Scripts -->
    <script src="engine.js"></script>
    <script src="ring.js"></script>
    <script>
        // ============================================
        // STARGATE MARK III - Rotary UI Controller
        // ============================================

        let glyphData = [];
        let addressData = [];
        let gate = null;
        let ringController = null;
        let currentMode = 7;

        const DOM = {
            terminal: document.getElementById('terminal'),
            innerRing: document.getElementById('innerRing'),
            outerRing: document.getElementById('outerRing'),
            eventHorizon: document.getElementById('eventHorizon'),
            stateDisplay: document.getElementById('stateDisplay'),
            statusIndicator: document.getElementById('statusIndicator'),
            modeSegment: document.getElementById('modeSegment'),
            modeLabels: document.querySelectorAll('.mode-label'),
            slotsContainer: document.getElementById('slotsContainer'),
            barGraph: document.getElementById('barGraph'),
            glyphKeyboard: document.getElementById('glyphKeyboard'),
            engageBtn: document.getElementById('engageBtn'),
            chevrons: document.querySelectorAll('.chevron')
        };

        // ============================================
        // INIT
        // ============================================
        async function init() {
            await loadData();
            gate = new GateStateMachine();
            setupStateListeners();
            ringController = new RingController(DOM.innerRing);
            generateGlyphs();
            generateKeyboard();
            generateBuffer();
            generateBarGraph();
            setupUI();
            console.log('[Mark III Rotary] Online.');
        }

        async function loadData() {
            try {
                const [glyphRes, addrRes] = await Promise.all([
                    fetch('data/glyphs.json'),
                    fetch('data/addresses.json')
                ]);
                glyphData = (await glyphRes.json()).symbols;
                addressData = (await addrRes.json()).addresses;
            } catch (err) {
                glyphData = Array.from({ length: 39 }, (_, i) => ({
                    id: i, name: `Glyph ${i}`, char: String.fromCharCode(65 + (i % 26))
                }));
            }
        }

        // ============================================
        // GENERATORS
        // ============================================
        function generateGlyphs() {
            DOM.innerRing.innerHTML = '';
            glyphData.forEach((glyph, i) => {
                const el = document.createElement('div');
                el.className = 'glyph';
                el.id = `glyph-${glyph.id}`;
                el.dataset.id = glyph.id;
                el.style.setProperty('--index', i);
                el.textContent = glyph.char;
                el.title = glyph.name;
                el.addEventListener('click', () => handleGlyphInput(glyph.id));
                DOM.innerRing.appendChild(el);
            });
        }

        function generateKeyboard() {
            DOM.glyphKeyboard.innerHTML = '';
            for (let i = 1; i <= 38; i++) {
                const glyph = glyphData[i];
                if (!glyph) continue;
                const btn = document.createElement('button');
                btn.className = 'glyph-key';
                btn.dataset.glyphId = i;
                btn.textContent = glyph.char;
                btn.title = glyph.name;
                btn.addEventListener('click', () => handleGlyphInput(i));
                DOM.glyphKeyboard.appendChild(btn);
            }
        }

        function generateBuffer() {
            const totalSlots = 9; // Always show 9 slots
            const activeSlots = currentMode - 1;

            // Update Title
            const titleEl = document.querySelector('.buffer-title');
            if (titleEl) titleEl.textContent = `ADDRESS BUFFER (${activeSlots} SLOTS)`;

            DOM.slotsContainer.innerHTML = '';
            DOM.slotsContainer.className = 'slots-container';

            const buffer = gate ? gate.getBuffer() : [];
            const nextIndex = buffer.length;

            for (let i = 0; i < totalSlots; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';

                if (buffer[i] !== undefined) {
                    slot.classList.add('filled');
                    slot.textContent = glyphData[buffer[i]]?.char || '?';
                } else if (i === nextIndex && i < activeSlots) {
                    slot.classList.add('cursor'); // Blinking cursor
                } else if (i >= activeSlots) {
                    slot.classList.add('locked');
                }
                DOM.slotsContainer.appendChild(slot);
            }
        }

        function generateBarGraph() {
            DOM.barGraph.innerHTML = '';
            const heights = [40, 70, 55, 85, 60, 90, 75, 95];
            heights.forEach((h, i) => {
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = h + '%';
                bar.style.animationDelay = (i * 0.1) + 's';
                DOM.barGraph.appendChild(bar);
            });
        }

        // ============================================
        // INPUT HANDLERS
        // ============================================
        function handleGlyphInput(glyphId) {
            const success = gate.addGlyph(glyphId);
            if (!success) return;

            const key = DOM.glyphKeyboard.querySelector(`[data-glyph-id="${glyphId}"]`);
            if (key) key.classList.add('selected');
            const glyph = document.getElementById(`glyph-${glyphId}`);
            if (glyph) glyph.classList.add('active');

            generateBuffer();

            const required = currentMode - 1;
            if (gate.getBuffer().length >= required) {
                DOM.engageBtn.disabled = false;
                DOM.engageBtn.classList.add('ready');
            }
        }

        function handleEngage() {
            if (gate.getState() !== GATE_STATES.DIALING) return;
            if (gate.getBuffer().length < currentMode - 1) return;
            DOM.engageBtn.disabled = true;
            DOM.engageBtn.classList.remove('ready');
            gate.initiateDialSequence();
        }

        function setMode(mode) {
            if (gate && gate.getState() !== GATE_STATES.IDLE) return;
            currentMode = mode;
            if (gate) gate.setMode(mode);

            DOM.modeSegment.dataset.mode = mode;
            DOM.modeLabels.forEach(l => {
                l.classList.toggle('active', parseInt(l.dataset.mode) === mode);
            });

            generateBuffer();
            resetKeyboardSelection();
        }

        // ============================================
        // STATE LISTENERS
        // ============================================
        function setupStateListeners() {
            gate.on('stateChange', ({ to }) => {
                DOM.stateDisplay.textContent = to.toUpperCase();
                DOM.statusIndicator.classList.toggle('active',
                    [GATE_STATES.DIALING, GATE_STATES.ACTIVE_OUTBOUND].includes(to));
                if (to === GATE_STATES.ACTIVE_OUTBOUND) triggerKawoosh();
            });

            gate.on('modeChange', ({ mode }) => {
                currentMode = mode;
                generateBuffer();
            });

            gate.on('glyphAdded', () => generateBuffer());

            gate.on('chevronEncoding', async ({ index, glyphId }) => {
                await ringController.rotateToGlyph(glyphId, index % 2 === 0);
            });

            gate.on('chevronLocked', ({ chevronNum }) => {
                const el = document.querySelector(`.chevron[data-num="${chevronNum}"]`);
                if (el) el.classList.add('locked');
            });

            gate.on('waitForRing', (resolve) => setTimeout(resolve, 1200));

            gate.on('validateAddress', ({ buffer, resolve }) => {
                const dest = addressData.find(a => JSON.stringify(a.coordinates) === JSON.stringify(buffer));
                resolve(dest || null);
            });

            gate.on('wormholeEstablished', () => { });
            gate.on('dialFailed', () => shakeTerminal());
            gate.on('aborted', () => DOM.eventHorizon.classList.remove('active', 'kawoosh'));
            gate.on('reset', resetUI);
            gate.on('error', () => { });
        }

        // ============================================
        // UI SETUP
        // ============================================
        function setupUI() {
            DOM.modeLabels.forEach(label => {
                label.addEventListener('click', () => setMode(parseInt(label.dataset.mode)));
            });

            document.querySelector('.rotary-knob').addEventListener('click', () => {
                let next = currentMode + 1;
                if (next > 9) next = 7;
                setMode(next);
            });

            DOM.engageBtn.addEventListener('click', handleEngage);

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && gate) gate.abort();
                if (e.key === 'Enter') handleEngage();
            });
        }

        // ============================================
        // HELPERS
        // ============================================
        function triggerKawoosh() {
            DOM.eventHorizon.classList.add('kawoosh');
            setTimeout(() => {
                DOM.eventHorizon.classList.remove('kawoosh');
                DOM.eventHorizon.classList.add('active');
            }, 800);
        }

        function shakeTerminal() {
            DOM.terminal.style.animation = 'none';
            DOM.terminal.offsetHeight;
            DOM.terminal.style.animation = 'shake 0.3s ease';
        }

        function resetKeyboardSelection() {
            DOM.glyphKeyboard.querySelectorAll('.glyph-key').forEach(k => k.classList.remove('selected'));
            document.querySelectorAll('.glyph').forEach(g => g.classList.remove('active', 'locked'));
        }

        function resetUI() {
            DOM.chevrons.forEach(c => c.classList.remove('encoded', 'locked'));
            resetKeyboardSelection();
            DOM.engageBtn.disabled = true;
            DOM.engageBtn.classList.remove('ready');
            DOM.eventHorizon.classList.remove('active', 'kawoosh');
            generateBuffer();
        }

        // Boot
        document.addEventListener('DOMContentLoaded', init);

        // Shake animation
        const style = document.createElement('style');
        style.textContent = `@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 75% { transform: translateX(3px); } }`;
        document.head.appendChild(style);
    </script>
</body>

</html>