<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Stargate Dialing Computer Mark III">
    <title>STARGATE DIALING SYSTEM v3.0</title>
    <link rel="stylesheet" href="dialingsystem_styles.css">
</head>

<body>

    <div class="terminal" id="terminal">
        <!-- Header -->
        <header class="header">
            <span class="header-title">STARGATE DIALING SYSTEM</span>
            <div class="header-status">
                <span id="stateDisplay">IDLE</span>
                <div class="status-indicator" id="statusIndicator"></div>
            </div>
        </header>

        <!-- Gate Viewport (Left 75%) -->
        <main class="gate-viewport">
            <div class="stargate">
                <div class="outer-ring" id="outerRing">
                    <div class="chevron" data-num="1"></div>
                    <div class="chevron" data-num="2"></div>
                    <div class="chevron" data-num="3"></div>
                    <div class="chevron" data-num="4"></div>
                    <div class="chevron" data-num="5"></div>
                    <div class="chevron" data-num="6"></div>
                    <div class="chevron" data-num="7"></div>
                    <div class="chevron" data-num="8"></div>
                    <div class="chevron" data-num="9"></div>
                </div>
                <div class="inner-ring" id="innerRing"></div>
                <div class="symbol-track"></div>
                <div class="event-horizon" id="eventHorizon"></div>
            </div>
        </main>

        <!-- Control Panel (Right 25%) -->
        <aside class="control-panel">
            <!-- Dial Mode -->
            <div class="panel-section">
                <div class="panel-label">Dial Mode</div>
                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="7" title="Intragalactic (Milky Way)">
                        <span class="mode-num">7</span>
                        <span class="mode-label">INTRA</span>
                    </button>
                    <button class="mode-btn" data-mode="8" title="Intergalactic (Pegasus)">
                        <span class="mode-num">8</span>
                        <span class="mode-label">INTER</span>
                    </button>
                    <button class="mode-btn" data-mode="9" title="Destiny (9-Chevron)">
                        <span class="mode-num">9</span>
                        <span class="mode-label">DESTINY</span>
                    </button>
                </div>
            </div>

            <!-- Address Buffer - Always 8 slots -->
            <div class="panel-section">
                <div class="panel-label">Address Buffer</div>
                <div class="address-buffer" id="addressBuffer">
                    <!-- Generated by JS with disabled slots -->
                </div>
            </div>

            <!-- Chevron Status -->
            <div class="panel-section">
                <div class="panel-label">Chevrons</div>
                <div class="chevron-progress" id="chevronProgress"></div>
            </div>

            <!-- Destination -->
            <div class="panel-section">
                <div class="panel-label">Destination</div>
                <div class="panel-value" id="destinationInfo">---</div>
            </div>

            <!-- Status -->
            <div class="panel-section">
                <div class="panel-label">Status</div>
                <div class="panel-value" id="statusMessage">AWAITING</div>
            </div>

            <!-- Keyboard -->
            <div class="panel-section keyboard-section">
                <div class="panel-label">DHD Input</div>
                <div class="keyboard-grid" id="keyboardGrid">
                    <!-- Generated by JS -->
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn-action btn-abort" id="abortBtn">ESC</button>
                    <button class="btn-action btn-engage" id="engageBtn" disabled>ENGAGE</button>
                    <button class="btn-action btn-reset" id="resetBtn">RST</button>
                </div>

                <!-- Auto Dial -->
                <button class="btn-auto" id="autoDialBtn">[ AUTO DIAL ABYDOS ]</button>
            </div>

            <!-- Footer Status -->
            <div class="status-footer">
                <span class="status-active" id="footerStatus">Click glyphs to dial</span>
            </div>
        </aside>
    </div>

    <!-- Scripts -->
    <script src="engine.js"></script>
    <script src="ring.js"></script>
    <script>
        // ============================================
        // MARK III - Left Gate / Right Controls
        // ============================================

        let glyphData = [];
        let addressData = [];
        let gate = null;
        let ringController = null;

        const DOM = {
            terminal: document.getElementById('terminal'),
            innerRing: document.getElementById('innerRing'),
            outerRing: document.getElementById('outerRing'),
            eventHorizon: document.getElementById('eventHorizon'),
            stateDisplay: document.getElementById('stateDisplay'),
            statusIndicator: document.getElementById('statusIndicator'),
            statusMessage: document.getElementById('statusMessage'),
            footerStatus: document.getElementById('footerStatus'),
            addressBuffer: document.getElementById('addressBuffer'),
            chevronProgress: document.getElementById('chevronProgress'),
            destinationInfo: document.getElementById('destinationInfo'),
            modeButtons: document.querySelectorAll('.mode-btn'),
            chevrons: document.querySelectorAll('.chevron'),
            keyboardGrid: document.getElementById('keyboardGrid'),
            engageBtn: document.getElementById('engageBtn'),
            abortBtn: document.getElementById('abortBtn'),
            resetBtn: document.getElementById('resetBtn'),
            autoDialBtn: document.getElementById('autoDialBtn')
        };

        // ============================================
        // INIT
        // ============================================
        async function init() {
            await loadData();
            gate = new GateStateMachine();
            setupStateListeners();
            ringController = new RingController(DOM.innerRing);
            generateGlyphs();
            generateKeyboard();
            setupUI();
            updateChevronProgress();
            console.log('[Mark III] Ready.');
        }

        async function loadData() {
            try {
                const [glyphRes, addrRes] = await Promise.all([
                    fetch('data/glyphs.json'),
                    fetch('data/addresses.json')
                ]);
                glyphData = (await glyphRes.json()).symbols;
                addressData = (await addrRes.json()).addresses;
            } catch (err) {
                glyphData = Array.from({ length: 39 }, (_, i) => ({
                    id: i, name: `Glyph ${i}`, char: String.fromCharCode(65 + (i % 26))
                }));
            }
        }

        function generateGlyphs() {
            DOM.innerRing.innerHTML = '';
            glyphData.forEach((glyph, i) => {
                const el = document.createElement('div');
                el.className = 'glyph';
                el.id = `glyph-${glyph.id}`;
                el.dataset.id = glyph.id;
                el.style.setProperty('--index', i);
                el.textContent = glyph.char;
                el.title = glyph.name;
                el.addEventListener('click', () => handleKeyPress(glyph.id));
                DOM.innerRing.appendChild(el);
            });
        }

        function generateKeyboard() {
            DOM.keyboardGrid.innerHTML = '';
            // Generate keys for glyphs 1-38 (excluding 0 = Earth PoO)
            for (let i = 1; i <= 38; i++) {
                const glyph = glyphData[i];
                if (!glyph) continue;

                const btn = document.createElement('button');
                btn.className = 'dhd-key';
                btn.dataset.glyphId = i;
                btn.textContent = glyph.char;
                btn.title = glyph.name;
                btn.addEventListener('click', () => handleKeyPress(i));
                DOM.keyboardGrid.appendChild(btn);
            }
        }

        // ============================================
        // INPUT HANDLERS
        // ============================================
        function handleKeyPress(glyphId) {
            const success = gate.addGlyph(glyphId);
            if (!success) return;

            // Update keyboard key visual
            const key = DOM.keyboardGrid.querySelector(`[data-glyph-id="${glyphId}"]`);
            if (key) key.classList.add('selected');

            // Update gate glyph visual
            const glyph = document.getElementById(`glyph-${glyphId}`);
            if (glyph) glyph.classList.add('active');

            // Check if address complete
            const maxGlyphs = gate.getMode() - 1;
            if (gate.getBuffer().length >= maxGlyphs) {
                DOM.engageBtn.disabled = false;
                DOM.engageBtn.classList.add('ready');
                setFooterStatus('PRESS ENGAGE');
            }
        }

        function handleEngage() {
            if (gate.getState() !== GATE_STATES.DIALING) return;
            if (gate.getBuffer().length < gate.getMode() - 1) return;

            DOM.engageBtn.disabled = true;
            DOM.engageBtn.classList.remove('ready');
            gate.initiateDialSequence();
        }

        function handleAbort() {
            gate.abort();
            ringController.stop();
        }

        function handleReset() {
            gate.reset();
            ringController.reset();
        }

        // ============================================
        // STATE LISTENERS
        // ============================================
        function setupStateListeners() {
            gate.on('stateChange', ({ to }) => {
                DOM.stateDisplay.textContent = to.toUpperCase();
                updateStatusIndicator(to);
                if (to === GATE_STATES.ACTIVE_OUTBOUND) triggerKawoosh();
            });

            gate.on('modeChange', () => {
                updateAddressBuffer();
                updateChevronProgress();
            });

            gate.on('glyphAdded', ({ buffer }) => {
                updateAddressBuffer(buffer);
                setStatus(`SYM ${buffer.length}`);
            });

            gate.on('chevronEncoding', async ({ index, glyphId }) => {
                setStatus(`CHV ${index + 1}`);
                updateChevronDot(index, 'encoded');
                await ringController.rotateToGlyph(glyphId, index % 2 === 0);
            });

            gate.on('chevronLocked', ({ chevronNum, total }) => {
                const el = document.querySelector(`.chevron[data-num="${chevronNum}"]`);
                if (el) el.classList.add('locked');
                updateChevronDot(total - 1, 'locked');
                setStatus(`CHV ${total} LOCKED`);
            });

            gate.on('waitForRing', (resolve) => setTimeout(resolve, 1200));

            gate.on('validateAddress', ({ buffer, resolve }) => {
                const dest = addressData.find(a => JSON.stringify(a.coordinates) === JSON.stringify(buffer));
                resolve(dest || null);
            });

            gate.on('wormholeEstablished', (dest) => {
                setStatus('ACTIVE');
                setFooterStatus('WORMHOLE ACTIVE');
                DOM.destinationInfo.textContent = dest.name;
            });

            gate.on('dialFailed', ({ reason }) => {
                setStatus('FAILED');
                setFooterStatus(reason);
                shakeTerminal();
            });

            gate.on('aborted', () => {
                setStatus('ABORT');
                setFooterStatus('ABORTED');
                DOM.eventHorizon.classList.remove('active', 'kawoosh');
            });

            gate.on('reset', resetUI);

            gate.on('error', ({ type }) => {
                if (type === 'duplicate_glyph') setFooterStatus('DUPLICATE');
                else if (type === 'buffer_full') setFooterStatus('BUFFER FULL');
            });
        }

        // ============================================
        // UI SETUP
        // ============================================
        function setupUI() {
            // Mode buttons
            DOM.modeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = parseInt(btn.dataset.mode);
                    if (gate.setMode(mode)) {
                        DOM.modeButtons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    }
                });
            });

            // Action buttons
            DOM.engageBtn.addEventListener('click', handleEngage);
            DOM.abortBtn.addEventListener('click', handleAbort);
            DOM.resetBtn.addEventListener('click', handleReset);
            DOM.autoDialBtn.addEventListener('click', () => autoDial([26, 6, 14, 31, 11, 2]));

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') handleAbort();
                if (e.key === 'Enter') handleEngage();
            });
        }

        // ============================================
        // UI UPDATES
        // ============================================
        function updateStatusIndicator(state) {
            const active = [GATE_STATES.DIALING, GATE_STATES.ACTIVE_OUTBOUND];
            DOM.statusIndicator.classList.toggle('active', active.includes(state));
        }

        function updateAddressBuffer(buffer = []) {
            const activeSlots = gate.getMode() - 1; // 6, 7, or 8
            const totalSlots = 8; // Always show 8 slots
            let html = '';
            for (let i = 0; i < totalSlots; i++) {
                const isDisabled = i >= activeSlots;
                const ch = buffer[i] !== undefined ? glyphData[buffer[i]]?.char || '?' : (isDisabled ? '' : '-');
                const cls = isDisabled ? 'disabled' : (buffer[i] !== undefined ? 'filled' : '');
                html += `<div class="buffer-slot ${cls}">${ch}</div>`;
            }
            DOM.addressBuffer.innerHTML = html;
        }

        function updateChevronProgress() {
            const activeChevrons = gate.getMode(); // 7, 8, or 9
            const totalChevrons = 9; // Always show 9
            let html = '';
            for (let i = 0; i < totalChevrons; i++) {
                const isDisabled = i >= activeChevrons;
                const cls = isDisabled ? 'disabled' : '';
                html += `<div class="chevron-dot ${cls}" data-index="${i}"></div>`;
            }
            DOM.chevronProgress.innerHTML = html;
        }

        function updateChevronDot(index, state) {
            const dot = DOM.chevronProgress.querySelector(`[data-index="${index}"]`);
            if (dot) {
                dot.classList.remove('encoded', 'locked');
                dot.classList.add(state);
            }
        }

        function setStatus(msg) { DOM.statusMessage.textContent = msg; }
        function setFooterStatus(msg) { DOM.footerStatus.textContent = msg; }

        function triggerKawoosh() {
            DOM.eventHorizon.classList.add('kawoosh');
            setTimeout(() => {
                DOM.eventHorizon.classList.remove('kawoosh');
                DOM.eventHorizon.classList.add('active');
            }, 800);
        }

        function shakeTerminal() {
            DOM.terminal.style.animation = 'none';
            DOM.terminal.offsetHeight;
            DOM.terminal.style.animation = 'shake 0.3s ease';
        }

        function resetUI() {
            DOM.chevrons.forEach(c => c.classList.remove('encoded', 'locked'));
            document.querySelectorAll('.glyph').forEach(g => g.classList.remove('active', 'locked'));
            DOM.keyboardGrid.querySelectorAll('.dhd-key').forEach(k => k.classList.remove('selected'));

            DOM.engageBtn.disabled = true;
            DOM.engageBtn.classList.remove('ready');

            updateAddressBuffer();
            updateChevronProgress();
            DOM.destinationInfo.textContent = '---';
            DOM.eventHorizon.classList.remove('active', 'kawoosh');
            setStatus('AWAITING');
            setFooterStatus('Click glyphs to dial');
        }

        // ============================================
        // HELPERS
        // ============================================
        async function autoDial(address) {
            for (const id of address) {
                handleKeyPress(id);
                await new Promise(r => setTimeout(r, 120));
            }
            setTimeout(handleEngage, 200);
        }

        // ============================================
        // BOOT
        // ============================================
        document.addEventListener('DOMContentLoaded', init);

        // Shake animation
        const style = document.createElement('style');
        style.textContent = `@keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 75% { transform: translateX(3px); } }`;
        document.head.appendChild(style);
    </script>

</body>

</html>